# 勘定科目別残高明細書作成システム PRD

## 1. プロダクト概要

### 1.1 プロダクト名

勘定科目別残高明細書作成システム（Account Balance Detail Generator）

### 1.2 目的

月次決算業務における勘定科目別残高明細書作成の自動化・効率化により、現在 3 日間かかる作業時間を大幅短縮する。

### 1.3 ターゲットユーザー

経理担当者（単一ユーザー）

## 2. 課題と解決策

### 2.1 現状の課題

- **主要課題**: 月次 1 万件の仕訳に対する手動案件分類作業（3 日間）
- **副次課題**: 部門別・科目別ファイル分割の手作業
- **リスク**: 案件分類精度による財務リスク評価の誤認

### 2.2 解決アプローチ

- 自動ファイル分割＋前月データ統合により構造化作業を自動化
- ドラッグ&ドロップ UI により案件分類作業を効率化
- リアルタイム計算により検証作業を簡素化

## 3. 機能要件

### 3.1 コア機能（MVP Phase1）

#### F001: Excel データ読込・自動分割機能

- 総勘定元帳 Excel ファイルのアップロード
- 部門別・科目別の自動データ分割
- **同一月度再アップロード**: 既存データの洗替更新（案件分類結果は保持）
- エラーハンドリング（不正フォーマット、欠損データ）

#### F002: 前月データ統合表示機能

- 前月データとの自動統合（参照用途）
- 当月仕訳の追加表示（集計対象は当月のみ）

#### F003: インタラクティブ案件分類機能

- 仕訳のドラッグ&ドロップ移動（案件間移動）
- 案件名のインライン編集（ダブルクリック）
- 新規案件作成（右クリックメニュー or 仕訳から新規作成）
- 案件の順序変更（案件集計行のドラッグ&ドロップ）
- 案件削除（右クリックメニュー）
- 案件の展開/折りたたみ（案件行全体クリック。三角アイコンは廃止）
- リアルタイム金額計算・表示

#### F004: Excel 出力機能

- 全部門・全科目の一括 Excel 出力
- 指定フォーマット（案件別 → 当月累計）
- ダウンロード機能

### 3.2 データ管理機能

#### F005: データ永続化機能

- 案件-仕訳対応関係の DB 保存
- 月次データの履歴管理（12 ヶ月保持）
- 案件名・分類結果の保存
- **洗替処理**: 同一月度再アップロード時の仕訳データ洗替（案件分類は継承）

#### F006: 前月整合性機能

- 前月分類結果との照合・表示（前月分は視覚的に区別表示）
- **AI保護**: 前月確定済み案件・仕訳紐付はAI推定機能の変更対象外
- **人間操作**: 前月分の手動変更（D&D移動・案件名編集等）は全て許可
- 監査対応: 月次推移比較の整合性確保

#### F007: AI 案件推定機能

- 摘要文キーワード解析
- 過去分類履歴との照合
- 推定精度の学習機能
- **適用範囲**: 当月新規仕訳の振分のみ（前月確定済み案件・仕訳紐付は対象外）
- **注意**: 人間による手動操作（前月分含む）には一切制限なし

#### F008: 案件名統一機能

- 表記ゆれ検出・統合提案
- 案件マスタ管理

## 4. 非機能要件

### 4.1 性能要件

- 1 万件仕訳の処理時間: 30 秒以内
- Excel 出力時間: 60 秒以内
- UI 応答時間: 1 秒以内

### 4.2 可用性要件

- システム稼働率: 95%以上
- データバックアップ: 日次

### 4.3 セキュリティ要件

- MVP につき特別要件なし
- 基本的な Web アプリケーションセキュリティ対策

## 5. データ設計

### 5.1 入力データ構造

```
総勘定元帳Excel（SS総勘定元帳.xlsx）:
- F列: 部門コード (string) - タブ構成に使用
- G列: 部門名称 (string) - タブ表示に使用  
- I列: 科目コード (string) - タブ構成に使用
- J列: 科目略称 (string) - タブ表示に使用
- V列: 伝票日付 (datetime) - 仕訳日付
- Z列: 伝票番号 (string) - 仕訳識別用
- AD列: 取引先・社員コード (string) - 取引先識別用
- AE列: 取引先・社員名称 (string) - 取引先名表示
- AH列: 借方金額 (number) - 借方仕訳金額
- AJ列: 貸方金額 (number) - 貸方仕訳金額
- AL列: 残高 (number) - 元帳上の累計残高（参考列・集計には不使用）
- AM列: 明細摘要１ (string) - 案件分類の判断材料
- 前月繰越行: AM列が「＊＊　前月繰越　＊＊」の行

データ規模例（SS総勘定元帳.xlsx）:
- 総データ行数: 2,442行（ヘッダー除く）
- 部門例: 池袋（コード：2100000000）
- 科目例: 未払費用（21701）、前払費用（12101）、社員仮払金（12414）等
- 前月繰越行: 約6行（科目別に存在）

明細摘要１サンプル（案件分類の判断材料）:
- 印刷関連: "エリアマップ優待券1000円券印刷代"
- 賃借料: "8月分 店舗建物賃借料(原価)", "9月分 その他土地賃借料(原価)"
- サービス券: "池袋東口公共地下駐車場 駐車サービス券"
- 月計行: "＊＊　８月計　＊＊"（処理対象外）
```

補足（UIスケルトン用マスタ）:
- 部門タブに表示する部門は `constants/masterdata/departments.ts` に固定定義（KISS/DRY）。
- 現時点の定義値: 2100000000 池袋 / 2110000000 上野 / 2120000000 錦糸町 / 2150000000 調布 / 2170000000 ひばりが丘 / 2200000000 渋谷 / 2250000000 吉祥寺 / 2310000000 心斎橋 / 2350000000 広島 / 2430000000 浦和 / 2470000000 福岡 / 2500000000 札幌 / 2560000000 仙台 / 2580000000 静岡 / 2600000000 名古屋
 - 科目タブに表示する科目は `constants/masterdata/subjects.ts` に固定定義（KISS/DRY）。
 - 現時点の定義値: 12101 前払費用 / 12406 専門店保険仮払金 / 12414 社員仮払金 / 12419 その他仮払金 / 21419 一般未払金 / 21701 未払費用 / 21422 一般未払金(加算)

### 5.2 出力データ構造

```
残高明細書:
- ◆案件集計行 (案件名, 当月合計)
- - 構成仕訳行 (取引先, 摘要, 金額)
- 当月累計行（全案件の当月合計。TBのBS残高と一致）
```

## 6. UI/UX 設計

### 6.1 画面構成

**単一メイン画面構成**:

- **ヘッダー**: 左から「対象年月(月選択)」「表示」「アップロード」 / 中央タイトル / 右端にダウンロードボタン
- **タブ構成**: 上位に部門タブ、下位に科目選択タブ（Excel 風のネストタブ）
- **テーブルエリア**: 案件分類/仕訳と当月累計のみを縦スクロール表示（繰越行は表示しない）
  - Card ラッパーは使用しない。テーブル直置き。
  - テーブル上の部門/科目名や対象年月のタイトル表示は行わない（ヘッダーの選択状態で代替）。
  - 右上ツールバー: 左に「保存」ボタン（bg-primary, shadcn/ui Button default）、右に「全案件オープン/クローズ」トグル（shadcn/ui Switch）。保存は将来のサーバ永続化用で、現時点はダミー実装（コンソール出力）。いずれも「表示」前や案件0件のときは無効化。
 - レイアウト（サイドバー）: `lg` 以下はサイドバー非表示、`xl` 以上で `inset` サイドバーを表示。

補足（2025-09-06 変更履歴）:
- 仕訳行は案件配下でも同一テーブル内の行として表示し、ヘッダー列との縦整合を担保（従来のネストテーブルは廃止）。
- 案件集計行のトグル（展開/折りたたみ）の左右余白を縮小し、仕訳エリアの見かけ上のインデントを軽減。
 - 年月選択＋「表示」ボタンと「アップロード」ボタンの導線を追加。アップロードは年月選択後にのみファイル選択を起動。
 - 初期表示は「対象年月未選択」の空状態（将来設定で最新月自動表示に切替可）。
  - 案件集計行の表示を2カラム化（取引先名／案件名）。

補足（2025-09-08 変更履歴）:
- ヘッダーと明細の列ズレ解消のため、ネストテーブル案を廃止し「同一`<table>`内の連続`<tr>`」に統一（案件行の直後に明細行を直接レンダリング）。
- 案件の開閉は「明細行の表示/非表示（即時切替）」に変更（アニメーションはいったん保留、必要になれば`tbody`単位の高さトランジション等で対応）。

補足（2025-09-09 変更履歴）:
- テーブル右上ツールバーに「保存」ボタンを追加（bg-primary）。案件・仕訳の入替後にユーザーが明示保存できる導線を用意。現時点はダミー（サーバ処理なし）。
- テキスト選択の改善: 案件行・仕訳行のテキストを通常のドラッグで選択・コピー可能に変更。
- 開閉操作の改善: 案件行全体をクリックで開閉する仕様に変更（従来の▼/►アイコンは廃止）。
- D&D操作の明確化: 行全体ドラッグではなく、セル左側の小さな「≡」ハンドルでのみドラッグ開始。
- ツールチップ調整: 案件行の取引先名はツールチップ廃止。仕訳行の取引先名/摘要のツールチップは維持。

**画面レイアウト**:

[案件行 表示例]:
```
[対象年月: YYYY-MM] [表示] [アップロード]   [システム名]   [ダウンロード]
─────────────────────────────────────────────────────────
[部門A] [部門B] [部門C] ...
    [科目1] [科目2] [科目3] ...
    ┌─────────────────────────────────────────┐
    │ （繰越行は非表示）                     │
    ├─────────────────────────────────────────┤
    │ 取引先名: 青木商事   案件名: キャンペーン対応 │ 借 1,000円 貸 0円 …
    │    - 青木商事, キャンペーン費用, 1,000円│
    │    - 青木商事, キャンペーン追加, 2,000円│
    │ ► ◆システム開発: 4,000円 [折りたたみ]  │
    ├─────────────────────────────────────────┤
    │ 当月累計: 17,000円（TBのBS残高と一致） │
    └─────────────────────────────────────────┘
```

### 6.2 主要インタラクション

**仕訳操作**:

- 仕訳行のドラッグ&ドロップ移動（案件間）
- 仕訳行の右クリック →「新規案件作成」メニュー

**案件操作**:

- 案件名のダブルクリック編集
- 案件集計行のドラッグ&ドロップ移動（順序変更。セル左側の「≡」ハンドルから開始）
- 案件集計行の右クリック →「案件削除」メニュー
- 行全体クリックで開閉（トグル）
 - 右上トグルで「全案件の一括展開/折りたたみ」

実装詳細（UI暫定版 / 2025-09-08）:

- D&D移動（仕訳→案件）: 仕訳行左側の「≡」ハンドルをドラッグし、移動先の「案件行」上にドロップで当該案件へ移動（仕訳行上に落としても同一案件扱い）。
- 新規案件作成（仕訳の右クリック）: 対象仕訳から「新規案件」を元案件の直下に即時作成し、その仕訳を移動。作成直後は自動展開。
- 案件名編集: 案件名セルのダブルクリックでインライン入力。Enter/フォーカス外しで確定、Escでキャンセル。
- 案件の順序変更: 案件行左側の「≡」ハンドルをドラッグし、他案件行へドロップ。行の上半分=前へ、下半分=後へ挿入。
- 案件削除: 案件行の右クリック →「案件を削除」。仕訳が残っている場合は「未分類」案件に自動退避してから削除（未分類が無い場合は自動作成）。
- 一括展開/折りたたみ: 右上トグル（Switch）で全案件の開閉を同期。データ未表示（表示前）や案件0件のときは無効化。
 - 保存: 右上「保存」ボタン（bg-primary）。押下時はいまは`console.info`に保存対象の概略（ym/部門/科目/案件数）を出力するのみ（将来Server Actionに置換）。データ未表示や案件0件のときは無効化。

## 7. 暫定実装メモ（DB準備までの対応）

- YAGNI/KISS/DRY に基づき、Excel から必要最小限の項目のみ抽出して JSON 化し、画面はその JSON を参照。
- 抽出スクリプト: `scripts/extract-balance-detail.ts`（依存: exceljs）
- 入力ファイル既定値: `docs/balance-detail/SS総勘定元帳_テストデータ.xlsx`
- 出力ファイル既定値: `app/balance-detail/sample-data.json`
- 実行コマンド例（Bun 推奨）:
  - `bun scripts/extract-balance-detail.ts --file=docs/balance-detail/SS総勘定元帳_テストデータ.xlsx --dept=2100000000 --subject=21701 --out=app/balance-detail/sample-data.json`
  - package.json スクリプト: `bun run extract:balance`
- フィルタ条件: 部門コード(F列)・科目コード(I列)。
- 除外・特別扱い:
  - `AM列` が「＊＊ 前月繰越 ＊＊」: 表示・集計ともにスキップ（繰越は本画面では不使用）。
  - `AM列` が「＊＊ n月計 ＊＊」: 月計行は除外（全半角混在対応）。
- 出力スキーマ（UI入力）:
  - `deptCode: string`, `deptName: string`
  - `subjectCode: string`, `subjectName: string`
  - `projects: { id: string; name: string; total: number; entries: Entry[] }[]`
  - `Entry`: `date(V) / voucherNo(Z) / partnerCode(AD) / partnerName(AE) / memo(AM) / debit(AH) / credit(AJ) / balance(AL) / month('current')`
- 案件(`projects`)のグルーピング: 原則として取引先名(AE列)で分割。取引先名が空の場合のみ摘要キーワード（印刷/賃借料/サービス券/システム開発）で補完。両方無い場合のみ「その他」。統合上限（上位N＋その他）は当面行わない。
 - 案件行表示仕様: 案件行は「取引先名」「案件名」を別カラムで表示。取引先名は各案件の先頭仕訳 `partnerName`、案件名は `projects[i].name` を用いる。案件名が未設定または取引先名と同一の場合は「案件名未設定」と表示（KISS）。
- テーブル列（8列）は左から `AD(取引先コード) / AE(取引先) / AM(摘要) / V(計上日) / Z(伝票番号) / AH(借方) / AJ(貸方) / AL(残高)` に変更。
  - 案件行では「AE=取引先名」「AM=案件名」を表示し、`AD=取引先コード` も表示する。`V/Z` は案件行では空表示。

### 7.1 画面の表示制御（データスコープ）

- 画面は `deptCode` と `subjectCode` が選択中タブと一致し、かつ「表示」押下で選択された `対象年月` が存在する場合のみ `projects` を表示する。
- 不一致の場合は「この部門・科目のデータは未生成です…」の空状態を表示し、集計値は0表示（当月累計）。
- 対象年月未選択時は「対象年月を選択し『表示』を押してください」を表示。

### 7.2 ヘッダー挙動

- 年月選択: `<input type="month">` を採用（HTMLネイティブ / KISS）。
- 表示ボタン: 選択年月で画面状態を更新（将来はサーバ取得）。
- アップロードボタン: 選択年月を前提にファイル選択ダイアログを起動。選択後（将来）Server Action で当該月度として取り込み・洗替。

### 7.3 初期表示方針（検討）

- 既定値: 「未表示（ユーザーが『表示』を押すまで待つ）」
  - 利点: 重い初回クエリを回避、誤月度表示の事故防止。
  - 欠点: ワンクリック増える。
- 代替案: 「最新月度を自動表示」
  - 利点: 即時可視化で利便性向上。
  - 欠点: 読み込みコスト、誤月度のまま操作されるリスク。
- 実装: `app/balance-detail/page.tsx` の `AUTO_SHOW_LATEST` で切替（既定: false）。

将来（F005〜F007）: DB 永続化・AI 推定導入時に抽出ロジックを差し替え予定。
- 空きエリアの右クリック →「新規案件作成」メニュー
- 三角アイコン（▼/►）クリックで仕訳の展開/折りたたみ

**リアルタイム更新**:

- 金額計算の自動更新表示
- 案件順序変更の即座反映

**前月分表示**:

- 視覚的区別（背景色・アイコン等）でAI変更対象外を明示
- 人間による手動操作（D&D・編集）は前月分も含め全て許可

## 7. 技術要件

### 7.1 推奨技術スタック

- **フロントエンド**: Next.js + TypeScript + Tailwind CSS
- **バックエンド**: Next.js ServerActions
- **データベース**: PostgreSQL
- **Excel 処理**: ExcelJS
- **UI**: shadcn/ui (ドラッグ&ドロップ対応)

### 7.2 アーキテクチャ方針

- **YAGNI**: 必要最小限の機能実装
- **DRY**: 共通処理のコンポーネント化
- **KISS**: シンプルな単一画面構成

## 8. 成功指標

### 8.1 定量指標

- 作業時間短縮: 3 日 →0.5 日（83%削減）
- エラー発生率: 月次 5 件 →1 件以下
- システム利用率: 100%（唯一の手段）

### 8.2 定性指標

- ユーザー満足度向上
- 月次決算業務の安定化
- 財務リスク評価精度向上

## 10. 受入テスト項目

### 10.1 基本機能テスト

- [ ] 正常な Excel ファイルのアップロード・分割処理
- [ ] 同一月度の再アップロード（洗替更新・案件分類継承）
- [ ] 前月データとの統合表示
- [ ] 仕訳のドラッグ&ドロップ移動
- [ ] 案件名の編集・保存
- [ ] リアルタイム金額計算の正確性
- [ ] Excel 出力ファイルのフォーマット確認
 - [ ] 全案件トグルの動作確認
   - [ ] オンで全案件が展開される
   - [ ] オフで全案件が折りたたまれる
   - [ ] 「表示」前や案件0件のときは無効化される
 - [ ] 保存ボタンの動作確認
   - [ ] 表示後にボタンが有効化される
   - [ ] 押下時にコンソールへ `[persist] ym=... dept=... subject=... projects=...` が出力される
   - [ ] 「表示」前や案件0件のときはボタンが無効化される
 - [ ] 仕訳右クリックメニュー
   - [ ] 「この仕訳から新規案件を作成」で新規案件が元案件直下に作成される
   - [ ] 仕訳が新規案件へ移動し、作成案件が自動展開される
 - [ ] 案件の並び替え
   - [ ] 案件行D&Dで意図した位置（前/後）に移動できる
 - [ ] 案件削除
   - [ ] 仕訳0件の案件を削除できる
   - [ ] 仕訳あり案件の削除で「未分類」へ全仕訳が退避される（未分類が無い場合は自動作成）

### 10.2 エラーハンドリングテスト

- [ ] 不正フォーマット Excel のエラー表示
- [ ] データ欠損時の適切なエラー表示
- [ ] 大量データ（1 万件）の処理性能

### 10.3 データ整合性テスト

- [ ] 前月データとの整合性確認
- [ ] 金額計算の正確性（手計算との照合）
- [ ] 案件分類結果の永続化確認

## 11. 実装状況（UIスケルトン v0.5 / 2025-09-07）

- 画面雛形: `app/balance-detail/page.tsx` を実装（肥大化解消のため適切に分割）
- ヘッダー: 左から「対象年月」「表示」「アップロード」（アップロードは年月選択必須）、中央タイトル、右「Excel出力（準備中）」
- タブ: 上段=部門、下段=科目の二段タブをshadcn風の下線タブに刷新。左端を揃えて視覚的なズレを解消
- テーブル: shadcn `Table`で「案件 → 仕訳 → 当月累計」を表現
  - 列構成: 取引先コード(AD) / 取引先(AE) / 摘要(AM) / 計上日(V) / 伝票番号(Z) / 借方(AH) / 貸方(AJ) / 残高(AL)
  - 列幅: 計上日列は初期状態で `min-width: 10ch` を指定し、`2025/08/25` が折り返さずに収まる幅を保証する。
  - 残高は「案件行のみ表示」。個々の仕訳行では非表示（空欄）。
  - 案件行はクリックで展開/折りたたみ（Collapsible: grid-template-rows のトランジション, 300ms, ease-in-out）
  - 「当月累計」のラベルは摘要列（3列目）に表示し、金額は残高列（最右列）に表示する。借方・貸方合計は当月累計行で従来どおり該当列に表示。
  - 色分け（可読性重視・淡色／bg-primary を活用）:
    - 当月案件行: `bg-primary/10 hover:bg-primary/20`
    - 当月仕訳行: 背景なし（`bg-background`相当）
    - 前月案件行: `bg-primary/5 hover:bg-primary/10`
    - 前月仕訳行: `bg-muted/20`
  - “◆”マークを案件名先頭から削除
  - D&D領域は「案件行の直下〜当該案件の全仕訳行」全体（今後実装）。プレースホルダ行（ダッシュ枠）は廃止。
- 非対応（今後）: ファイル入出力、D&D、右クリックメニュー、AI推定、DB 永続化、Server Actions

### 11.1 コンポーネント分割（YAGNI/DRY/KISS）

- `components/balance-detail/header-bar.tsx`: ヘッダー（年月選択・表示・アップロード/タイトル/出力）
- `components/balance-detail/tab-row.tsx`: 下線タブ行（部門/科目で再利用）
- `components/common/collapsible.tsx`: 汎用コラプス（gridベースのトランジション）
- `lib/format.ts`: 表示用フォーマッタ（`formatJPY`, `formatDateJP`）
- `types/balance-detail.ts`: ドメイン型（`Entry`, `Project`）

過剰分割は避け、ページ本体では「状態管理＋表の描画」に専念できる構成とした。


---

**作成日**: 2025-09-08  
**バージョン**: 1.8  
**作成者**: Claude Code
