# 勘定科目別残高明細書作成システム PRD

本ドキュメントは「勘定科目別残高明細書作成システム」の機能要件・UI仕様・データ仕様を一元管理する。記述は簡潔さと一貫性を優先しつつ、意思決定に必要な情報は保持する（YAGNI / DRY / KISS）。

## 1. 概要

- 目的: 月次決算における残高明細作成を自動化・効率化（現状3日 → 大幅短縮）。
- 対象ユーザー: 経理担当者（単一ユーザー想定）。
- 成果物: 案件別の当月合計と全体の当月累計を備えた残高明細。

## 2. 課題と解決方針

- 課題: 1万件規模の仕訳に対する手動案件分類、部門/科目ごとの手作業分割、誤分類リスク。
- 方針: Excel取込の自動分割＋前月統合、UIでのD&D分類、リアルタイム集計で検証容易化。

## 3. 機能要件（MVP → 拡張）

- F001 取込/自動分割: 元帳Excelアップロード、部門/科目で自動分割、同一月度は洗替（分類は保持）。
- F002 前月統合表示: 前月仕訳を参照表示（視覚的区別）。集計は当月のみ対象。
- F003 分類UI: 仕訳のD&D移動、案件名インライン編集、新規案件作成、案件順序変更、案件削除、案件開閉、リアルタイム集計。
- F004 Excel出力: 全部門・全科目の一括出力（案件別→当月累計）。
- F005 永続化: 案件-仕訳対応、案件名、履歴（12ヶ月）、洗替時の分類継承。
- F006 前月整合: 前月分類との照合、確定分はAI対象外、人手変更は常に許可、監査用整合性担保。
- F007 AI推定: 摘要・履歴を用いた分類推定（当月新規のみ）。
- F008 案件名統一: 表記ゆれ検出と統合提案、案件マスタ。

注記: 現在はF003のUI操作、F001のBlob経由Excel取込→DB永続化（MVP・洗替継承含む）を実装。F004以降は計画段階。

## 4. 非機能要件

- 性能: 1万件処理≤30秒、出力≤60秒、UI応答≤1秒。
- 可用性: 稼働率≥95%、バックアップ日次。
- セキュリティ: 一般的なWeb対策。MVP特記事項なし。

## 5. データ仕様

### 5.1 入力（元帳Excel → 抽出JSON）

- 主フィールド: 部門コード(F) / 部門名(G) / 科目コード(I) / 科目名(J) / 計上日(V) / 伝票番号(Z) / 取引先コード(AD) / 取引先名(AE) / 摘要(AM) / 借方(AH) / 貸方(AJ) / 残高(AL)。
- 除外: 「前月繰越」「n月計」など集計行は対象外。
- 抽出スクリプト: `scripts/extract-balance-detail.ts`（exceljs）。
- 出力先: `app/balance-detail/sample-data.json`（MVP検証用）。

### 5.2 UI入力スキーマ

- Dataset: `{ deptCode, deptName, subjectCode, subjectName, projects: Project[] }`
- Project: `{ id, name, total, entries: Entry[] }`
- Entry: `{ id, date, voucherNo, partnerCode, partnerName, memo, debit, credit, balance, month }`（`month: 'prev' | 'current'`）

### 5.3 出力（残高明細）

- 構成: 案件集計行（案件名, 当月合計）→配下仕訳行→当月累計行。

## 6. 画面仕様（/balance-detail）

### 6.1 レイアウト

- ヘッダー: 対象年月（`<input type="month">`）/ 表示 / アップロード / Excel出力（準備中）。
- 二段タブ: 上段=部門、下段=科目（`TabRow`）。
- テーブル: `Table` 直置き（Card無し）。右上に「保存」「全案件トグル」。

### 6.2 テーブル列（8列）

- 取引先コード(AD) / 取引先名(AE) / 摘要(AM: 案件行では案件名) / 計上日(V) / 伝票番号(Z) / 借方(AH) / 貸方(AJ) / 残高(AL: 案件行のみ)。

### 6.3 主要インタラクション（F003）

- 仕訳D&D: 行左の「≡」ハンドルから開始→案件行へドロップで移動。
- 新規案件: 仕訳行を右クリック→「この仕訳から新規案件を作成」。元案件直下に作成し自動展開。
- 案件名編集: 案件行の摘要セルをダブルクリック→インライン編集（Enter/Blur確定、Esc取消）。
- 案件順序: 案件行の「≡」でドラッグ→他案件行の上半分=前/下半分=後に挿入。
- 案件削除: 案件行を右クリック→「案件を削除」。仕訳が残る場合は「未分類」案件に退避（無ければ自動作成）。
- 展開制御: 案件行クリックで開閉、右上トグルで一括開閉。
- 保存: クリックで `console.info` に保存対象概要を出力（将来Server Actionに置換）。

## 7. アーキテクチャ/コンポーネント

- `app/balance-detail/page.tsx`: 画面状態のオーケストレーション（部門/科目/年月、展開状態、`projects`）。
- `components/balance-detail/header-bar.tsx`: ヘッダー（年月・表示・アップロード）。
- `components/balance-detail/tab-row.tsx`: 下線タブ。
- `components/balance-detail/expand-all-toggle.tsx`: 全案件トグル。
- `components/balance-detail/projects-table.tsx`: テーブル本体。D&D・右クリック・編集の一時状態を内包し、イベントでpageへ通知。
- `components/balance-detail/context-menu.tsx`: 汎用右クリックメニューの軽量オーバーレイ。

## 8. 表示制御（データスコープ）

- `deptCode`/`subjectCode` が選択タブと一致し、かつ対象年月が「表示」された場合に限り `projects` を表示。
- 不一致時は「この部門・科目のデータは未生成…」を表示。
- 対象年月未選択時は「対象年月を選択し『表示』を押してください」。

### 8.1 アップロード後の自動表示（2025-09-09 変更）
- Excelアップロード完了時点で、対象年月を自動的に「表示」状態に切替する（UIの「表示」ボタン操作は不要）。
- その直後、Server Action `getBalanceAllAction(ym)` を1回だけ呼び出し、当該年月の「全部門×科目」の明細・案件・リンクを一括取得する。
  - クライアント側では取得済みペイロードをローカル整形して、選択中の部門・科目のみ部分表示（フィルタリング）。
  - 目的: リクエスト多発を避け、体感性能を向上（DRY/KISS）。
 - 「表示」ボタンの役割は「アップロードを行わずに既存データを閲覧する」場合に限定する。

## 9. 実装メモ（暫定）

- JSONベースの疑似永続。Excelアップロード・DB保存はServer Action/DBで将来実装。
- 抽出実行例: `bun scripts/extract-balance-detail.ts --file=docs/balance-detail/SS総勘定元帳_テストデータ.xlsx --dept=2100000000 --subject=21701 --out=app/balance-detail/sample-data.json`
- Package Script: `bun run extract:balance`。

## 10. 受入基準（UI）

- 表示制御: 対象年月未選択→空状態。不一致データ→未生成メッセージ。表示後→案件・明細が出る。
- D&D: 仕訳の案件間移動ができ、金額が即時再計算される。案件の順序変更ができる。
- 編集: 案件名をインライン編集できる（Enter/Blur確定、Esc取消）。
- 右クリック: 仕訳→新規案件作成が成功、案件→削除で未分類へ退避。
- 一括展開: トグルで全案件の開閉が同期する。
- 保存: 条件を満たす時のみ有効化され、`console.info` 出力が行われる。

## 11. 変更履歴（抜粋）

- 2025-09-09: 案件名インライン編集の安定化。`onChange` で入力値をローカル変数へ退避してから状態更新する実装に変更し、`currentTarget` が `null` となる稀なタイミングでの実行時例外（Cannot read properties of null (reading 'value')）を解消（KISS）。
- 2025-09-09: 表示のデータ取得を「スコープごとの多数リクエスト」→「月度1回の一括取得+クライアント整形」に変更。
- 2025-09-09: アップロード完了後に対象年月を自動表示し、全スコープをバックグラウンドで読み込む仕様に変更。
- 2025-09-09: OpenAIトレース整備。ファイルアップロード開始時にトップレベルトレース「YYYY/MM/DD HH:MM:SS ファイルアップロード」を開始し、各取引先×バッチをCustom Spanとして記録。各バッチ内のResponses API呼び出しはResponse Spanで紐付け、ダッシュボードのTracesで階層的に閲覧できる。
- 2025-09-09: ドキュメント全体の再編・記述統一。UIを `ProjectsTable`/`ContextMenuOverlay` へ分離。右上「保存」追加。D&D/右クリック/編集仕様を確定。
- 2025-09-08: ネストテーブル廃止。案件行直後に明細行を描画。開閉は即時切替。
- 2025-09-06: 初期スケルトン作成。二段タブ導入。空状態/未生成メッセージ整備。
 - 2025-09-11: ページマウント時のNeon Warmup処理を削除（`app/balance-detail/page.tsx` のWarmup用 `useEffect` と `neonWarmupAction` を廃止）。

---

作成日: 2025-09-08  
最終更新: 2025-09-11  
版: 2.2  
作成者: プロジェクトチーム
