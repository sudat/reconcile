# PRD: 本支店勘定照合の自動化

本書は、経理業務における本支店勘定の照合作業を自動化するための製品要件定義（PRD）である。現時点でユーザから確定した要件のみを確定事項として反映し、未決事項はTBDとして残す。（KISS）

---

## 1. 背景と目的
- 各支店間の本支店勘定の一致確認を月次で行っており、手作業の負荷と人的ミスを削減したい。
- 既存の会計システム出力（試算表・総勘定元帳・マッピングマスタ）を入力として、自動で不一致の特定と結果出力を行う。

## 2. スコープ
- 対象勘定: 本支店勘定（支店間で対になる勘定の組）
- 対象拠点: 支店10拠点（想定）
- データ規模の目安:
  - 試算表: 単一ファイル、約1,000行
  - 総勘定元帳: 支店ごとに1ファイル、各ファイル約10,000行
- 非対象: 多通貨（JPY以外）、小数点付き金額、許容誤差を伴う曖昧照合（YAGNI）

## 3. 期間と計算規約
- 期間指定: `YYYY-MM`（例: 2025-08）で指定。
- 試算表の計算思想（既存システム仕様に準拠）:
  - 当該期間に発生した仕訳の「借方発生額」「貸方発生額」をグロスで集計。
  - それを純額化（借方発生−貸方発生、または規約に基づく符号化）し、期首残高に加算して期末残高を求める。
  - 本PRDでは、試算表ファイルに含まれる「期末残高」を一次比較値とする（再計算は行わない）。（KISS）

## 4. 入力と取得方法
- 入力経路: Next.jsのフロント画面からユーザがアップロード。
- 画面から指定/アップロードするもの:
  1) 期間（`YYYY-MM`）
  2) マッピングマスタ（全体で1ファイル）
  3) 試算表ファイル（全体で1ファイル）
  4) 計上部門別に出力した総勘定元帳ファイル（支店ごとに1ファイル）。アップローダは `BRANCHES` の定義分だけ表示し、支店名付きで個別に指定する（例: 本社, 心斎橋店, …）。

### 4.5 簡易ペア突合（LedgerForm / 2ファイル）
- 目的: ユーザが支店A・支店Bの元帳（各1ファイル）を直接指定し、当該2拠点間の本支店勘定を日別に突合する簡易フロー。
- 画面: `LedgerForm`（`TbForm` の下に配置、カードUI統一）
- 入力: `期間(YYYY-MM)`, `支店A`, `支店Aの元帳(XLSX)`, `支店B`, `支店Bの元帳(XLSX)`
- 処理: 両ファイルから勘定 `11652090` の明細を取得し、
  - Aファイルからは「B向き」の行のみ、Bファイルからは「A向き」の行のみを抽出（相手先は補助科目コード→支店コードの静的表、なければ補助科目名の先頭一致で解決）。
  - 日付ごとに金額（借方-貸方）を配列化。日次の合計 `sumA`, `sumB`, `diff=sumA+sumB` を計算。
- 出力: `xlsx`（既定）。シート `by_day` は `date, Sub:A_<sub>..., Sub:B_<sub>..., sumA, sumB, diff` の列構成。
  - `Sub:A_<sub>` は支店Aファイルにおける「支店B向け」の補助科目コード列、`Sub:B_<sub>` は支店Bファイルにおける「支店A向け」の補助科目コード列。
  - 列は静的マスタ（subaccount-branch-map）から、相手支店コードに紐づくSubaccountのみを昇順で採用。
  - 列数が20を超える場合はエラーで中断（ユーザ要望。YAGNI）。
- 備考: CSV出力は将来オプション（YAGNI）。

#### 4.5.2 アンマッチ抽出と出力（2025-09-04 追加）
- トリガー: `by_day.diff` が 0 以外となった日付が1つでもある場合。
- 抽出対象: 当該日付のうち、
  - Aファイルは「B向け」明細のみ、Bファイルは「A向け」明細のみ（既存ロジックと同一）。
  - AとBで同一仕訳金額（絶対値）が1:1で対応する行は除外。
  - 対応が取れなかった行のみをアンマッチとする。
- アンマッチファイルのレイアウト（XLSX, シート名 `unmatched`）
  - 1行目: ヘッダ。左に `A:` プレフィックス付きで総勘定元帳の全列（`LEDGER_HEADER`）、右に `B:` で同じ列を並べる。
  - 2行目以降: まずA側のアンマッチ行（左にAの値、右は空欄）を全件、その後にB側のアンマッチ行（左空欄／右にBの値）を全件。
  - 例: Aが10行、Bが20行 → 1行目ヘッダ、2–11行目A、12–31行目B。
  - 金額比較は `(借方+借方税) - (貸方+貸方税)` の符号込みで実施し、AとBの合計が0になるペアを相殺対象とする。

#### 4.5.1 アップロード方式（2025-09-04変更）
- 背景: 大容量XLSXの直接POSTでVercelのボディ上限によりHTTP 413が発生。
- 方式: クライアント→Vercel Blobへ直接アップロード（multipart）し、Server ActionにはBlobのURLのみを渡す。
- 影響: サーバ側のリクエストサイズは小さくなり、413を回避。Blobのライフサイクル管理（保持期間/削除）は運用要件として別管理。

### 4.1 ファイル共通仕様
- 形式: すべて `XLSX`。
- 文字コード: XLSX準拠（内部はバイナリ）。
- 金額・通貨: 通貨は `JPY` のみ。小数点なし。端数処理なし。
- 許容誤差: なし（完全一致判定）。
- シート選択: 先頭シート固定（両方とも `Sheet1` だが名称は不問）。
- データ開始行:
  - 試算表: 1行目がヘッダ、2行目以降が明細。
  - 総勘定元帳: 1行目がヘッダ、2行目が期首残、3行目以降が期中仕訳。
 - 入力クレンジング:
   - 全角/半角・前後スペース: そのまま扱う（自動変換しない）。
   - ゼロ埋め: 支店コード・勘定科目コードはExcel上の先頭ゼロを保持し、文字列として扱う（数値化しない）。

### 4.2 マッピングマスタ（XLSX）
- 目的: 支店×勘定の突合ペア定義（1対1に限定、MVP）。
- 最低限必要な列（案）:
  - `branch_a`（支店Aコード/名称のいずれか）
  - `account_a`（支店A側の勘定科目コード/名称のいずれか）
  - `branch_b`
  - `account_b`
  - `active`（true/false）
- 将来拡張の候補（TBD）: 有効開始/終了日、備考、許容誤差、補助科目条件など（YAGNI）。

### 4.3 試算表ファイル（XLSX）
- 列マッピング（確定／`constants/reports/report-header.ts` の `TB_HEADER` に準拠）
  - 支店コード: `対象組織コード`（col 6）
  - 支店名: `対象組織名`（col 7）
  - 勘定科目コード: `勘定科目コード`（col 11）
  - 勘定科目名: `勘定科目名`（col 12）
  - 補助科目コード/名: `補助科目コード`（col 13）, `補助科目名`（col 14）
  - 科目貸借区分: `科目貸借区分`（col 19, コード: 0=借方, 1=貸方）
  - 期首残高: `期間前基準金額`（col 22）
  - 当期借方/貸方（グロス）: `期間内借方基準金額`（col 23）, `期間内貸方基準金額`（col 24）
  - 期末残高: `累計基準金額`（col 25）→ 一次比較値として使用
- 科目フィルタ: 勘定科目コードは `11652090` のみ対象（本支店勘定）。

### 4.4 総勘定元帳ファイル（XLSX, 支店ごとに複数）
- 列マッピング（確定／`constants/reports/report-header.ts` の `LEDGER_HEADER` に準拠）
  - 支店コード/名: `対象組織コード`（col 12）, `対象組織名`（col 13）
  - 勘定科目コード/名: `勘定科目コード`（col 86 を採用）, `勘定科目名`（col 87）
  - 補助科目コード/名: `補助科目コード`（col 88）, `補助科目名`（col 89）
  - 計上日: `計上日`（col 37, 値は「文字列 `yyyymmdd`」または「Excel日付（Date）」のいずれでも可。システム側で `yyyymmdd` に正規化して扱う）
  - 貸借区分: `貸借区分`（col 75, コード: 0=借方, 1=貸方）
  - 伝票/行キー: `仕訳番号`（col 18）, `行番号`（col 77）
  - 金額（算出）:
    - 借方合計 = `借方入力金額`（col 97） + `借方入力税額`（col 99）
    - 貸方合計 = `貸方入力金額`（col 101） + `貸方入力税額`（col 103）
    - `amount` = 借方合計 − 貸方合計（税額も含めて評価）
  - 期首行の扱い: 2行目（期首残）は日次残高の初期値として利用し、仕訳レベル突合の抽出対象からは除外。
  - 期間フィルタ: 計上日（`yyyymmdd`）の先頭7桁が `YYYYMM` と一致する行を対象。

> ヘッダー名はユーザ回答待ち（TBD）。確定後に厳密な列マッピングを追記する。（KISS）

## 5. 符号/残高の取り扱い規約（確定）
- 貸借区分の規約:
  - 財務諸表で借方にのせる科目は「借方」、貸方にのせる科目は「貸方」とする。
- 金額列の符号規約:
  - 借方科目で借方残高であればプラス。
  - 貸方科目で貸方残高であればプラス。
  - 上記以外はマイナス。
- 許容誤差はゼロ（完全一致）。

## 6. 照合ロジック（3段階）
1) 試算表比較（期末残高）
- マッピングマスタの各ペア（branch_a/account_a, branch_b/account_b）について、試算表の期末残高（`balance_end`）を比較。
- 一致: OK。/ 不一致: ペアを「不一致」として次段へ。

2) 日次残高の突合（総勘定元帳）
- 不一致ペアについて、支店Aと支店Bの総勘定元帳を「日別×勘定」で集計し、日次残高推移を生成。
- 期間中に初めて乖離が発生する日付（ズレ初日）を特定。

3) 仕訳レベル突合
- ズレ初日以降（または当日）に限定し、仕訳明細をキーで照合。
- 照合キー（確定）: `勘定科目コード(86)`, `計上日(37)`, `amount(算出)`, `貸借区分(75)`, `仕訳番号(18)`, `行番号(77)`。
- 片側のみ存在する行（unmatched）を抽出し、Excelにまとめて出力。

### 6.1 エッジケース/異常値の扱い
- 行欠落/列欠落/壊れファイル: フェイルファストでエラー終了（エラーメッセージ明示）。
- 二重計上/逆仕訳: 同一キー重複はまとめて差額で評価（MVPでは単純和集合で比較、詳細突合は将来対応）。（YAGNI）
- 締め後調整や月跨ぎ: 本MVPは当月計上分のみを評価（翌月逆仕訳等の評価はTBD）。（YAGNI）

## 7. 出力/UX
- 例外Excel（仕訳不一致一覧）
  - 列（案）: `mapping_id`（行番号でも可）, `branch`, `account`, `posting_date`, `drcr`, `amount`, `source_file`, `source_row`, `side`（A/B）
  - 色分け/ハイライト: A側のみ/B側のみを色で区別
- サマリ出力（CSVまたはXLSX）
  - ペア単位の一致/不一致、差額金額、ズレ初日、件数合計
- 画面（Next.js）
  - 入力: 期間（`YYYY-MM`）、マッピング1ファイル、試算表1ファイル、元帳複数ファイル
  - 実行ボタン、進捗表示、結果ダウンロード（例外Excel/サマリ）

### 7.3 実行時のフィードバック（2025-09-04変更）
- TB/元帳の両フォームで、実行ボタン内にスピナーを表示して処理中であることを明示（KISS）。
- 元帳A/Bフォームの実行ボタン下にリアルタイムログを表示。
  - 例: 「[1/4] ファイルをアップロード…」→「[2/4] サーバで照合中…」→「[3/4] 結果ファイルを作成中…」→「[4/4] ダウンロード開始」
  - エラー発生時は直近ステップのログにエラー内容を追記（DRY: クライアント側で統一）。
  - アンマッチありの場合は追加で「[追加] アンマッチ抽出…」「アンマッチファイルをダウンロード…」の行を出す。

### 7.1 ペアリング/除外ルール（確定）
- ペアリング範囲: 全支店の全ペア（例: 10支店なら45通り）を対象。
- 除外: サブ科目「セグメント間消去」は除外し、それ以外（回金/買掛金立替/給与/賞与/本支店取引 等）は対象。
- 名称ゆれ: 支店名はコードを正とし、名称はエイリアス辞書で正規化。
  - エイリアス辞書: `constants/masterdata/aliases.ts`（`BRANCH_ALIAS_TO_CODE`）。
    - 補助科目名の表記ゆれは使用せず、支店名の表記ゆれで吸収（KISS/DRY）。
  - 画面トグル: 「支店集約」（既定: ON）。神戸エリア（神戸/須磨/芦屋）を集約。

### 7.2 例外Excelの列構成（提案）
- 目的: 「どの支店・どの勘定の・どの日付・どの明細が片側のみか」を人が即判断できる最小限の列。
- 列順（提案）:
  1) `side`（A/B）
  2) `branch_code` / `branch_name`
  3) `account_code` / `subaccount_code`
  4) `posting_date`（yyyymmdd）
  5) `drcr_code`（0/1）
  6) `amount`
  7) `voucher_no`（仕訳番号）
  8) `line_no`（行番号）
  9) `source_file`（元ファイル名）
  10) `source_row`（元行番号）
- A/B双方の対応行が揃う場合は表示せず、片側のみ抽出。
- 相手側の支店コード/名称は列数膨張のためMVPでは非表示（必要なら追記可能）。

## 8. 実行・非機能
- 実行形態: フロントからのアップロード→サーバ側で処理（Next.js サーバーアクション）。
  - 実装: `tbReconcileAction`（TBサマリ）, `ledgerReconcileAction`（元帳A/B日別）。
  - ファイル入出力: Ledgerの入力はVercel Blob URL経由とし、大容量ファイルでも413を回避する。
- パフォーマンス目標（参考）: 合計10万〜20万行規模で数十秒〜数分以内。
- ログ/監査: 入力ファイル名、行数、ハッシュ（MD5等）、実行時刻、実行者、マッピング版、検出件数を記録。
- 再現性: 同一入力に対して同一結果（DRY: 共通ロジック化）。
- エラー処理: 最初の致命的エラーで停止、ユーザに原因と該当ファイル/列を提示。

## 9. MVP範囲（KISS/YAGNI）
- 単一通貨JPYのみ、端数・許容誤差なし。
- マッピングは1対1のみ。補助科目・フィルタなし。
- 試算表は期末残高で一次比較。日次→仕訳突合は不一致ペアのみ実施。
- 入力はすべてXLSX。フロントからの手動アップロードのみ。
- 出力は「例外Excel」と「サマリ」の2種。

## 10. 受入テスト（チェックリスト）
- 期間指定: `YYYY-MM` を受け取り、対象期間のデータのみ処理する。
- 試算表比較: マッピング全ペアで一致/不一致の判定が正しい。
- 日次突合: 不一致ペアに対し、ズレ初日が正しく特定される。
- 仕訳突合: ズレ日付を絞り込んだ未一致行が完全に抽出される。
- 例外Excel: 指定列が出力され、A/Bの片側有りが明確に判別できる。
- サマリ: ペア単位の差額・件数・ズレ初日が正しい。
- 元帳A/B（by_day）: `diff=0` の日のみ単一ファイル、`diff!=0` を含む場合はアンマッチファイルも同時にダウンロードされる。
- アンマッチ: ヘッダ1行後にA明細→B明細、同額（絶対値）のペアは除外されている。
- 再現性: 同一入力で再実行すると同一結果になる。
- エラー時: 欠落列/壊れファイルで停止し、原因・ファイル名・列名を明示する。
 - ゼロ埋め保持: 支店コード・勘定科目コードの先頭ゼロが保持されている。

## 11. 未決事項（TBD）
- 列のデータ型の厳密化（空白・ゼロ幅の扱い）。
- 月跨ぎ調整の扱い（翌月逆仕訳の自動スキップ基準）。
- ログ保存先・保持期間、アクセス権限。
- 元帳ファイルの未提出支店がある場合の扱い（全件必須か、欠損はスキップか）。

---

## 12. 原則の適用
- KISS: 期末残高の一次比較、1対1マッピング、XLSX限定によりシンプル化。
- YAGNI: 多対マッピング、許容誤差、多通貨、複雑な月跨ぎ除外は後回し。
- DRY: 集計・比較・出力の共通ユーティリティ化を前提とし、同一ロジックを使い回す。
